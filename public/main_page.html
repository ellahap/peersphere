<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://apis.google.com/js/api.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PeerSphere</title>
  <style>
    body {
      display: flex;
      margin: 0;
      font-family: Courier, monospace;
      background: #f5f5f5;
      height: 100vh;
    }
    h2 {
      margin-bottom: 10px;
      padding-bottom: 5px;
    }
    .sidebar {
      background: #dbdbdb;
      padding: 20px;
      width: 200px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      justify-content: space-between;
      height: auto;
      max-height: 100vh;
      overflow-y: auto;
    }
    .group-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .group-item {
      display: block;
      padding: 10px;
      border-radius: 20px;
      text-decoration: none;
      color: black;
      cursor: pointer;
      width: 100%;
      box-sizing: border-box;
      text-align: left;
      margin-bottom: 5px;
      position: relative;
    }
    .group-item.active {
      background: #1f497d;
      color: white;
    }
    .group-code {
      font-size: 0.8em;
      color: #666;
      margin-top: 5px;
    }
    .group-item.active .group-code {
      color: #ccc;
    }
    .main-content {
      flex-grow: 1;
      padding: 20px;
    }
    .header {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    .tabs {
      display: flex;
      gap: 50px;
      padding-top: 5px;
      padding-bottom: 20px;
    }
    .tabs a {
      text-decoration: none;
      color: black;
      background-color: #dbdbdb;
      padding: 10px 20px;
      border-radius: 10px;
      font-weight: bold;
      transition: background-color 0.3s;
    }

    .tabs a:hover {
      background-color: #1f497d;
      color: white;
    }

    .resources {
      display: grid;
      grid-template-columns: repeat(3, 200px);
      gap: 20px;
      margin-top: 20px;
    }
    .resource-item {
      background: #e0e0e0;
      padding: 20px;
      border-radius: 20px;
      text-align: center;
      font-weight: bold;
      width: 200px;
      height: 225px;
      justify-content: center;
      position: relative;
    }
    .resource-item > * {
      margin-top: 0;
    }
    .add-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background: rgb(47, 47, 47);
      color: white;
      border-radius: 50%;
      font-size: 40px;
      text-align: center;
      line-height: 60px;
      cursor: pointer;
    }
    .add-group-btn, .join-group-btn {
      padding: 10px;
      border-radius: 5px;
      border: none;
      color: white;
      cursor: pointer;
      text-align: center;
      margin-top: 10px;
      width: 100%;
      background: #1f497d;
    }
    .modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      width: 300px;
    }
    .modal h2 {
      margin-top: 0;
    }
    .modal input {
      width: 92%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .modal button {
      padding: 10px 20px;
      background: #1f497d;
      color: white;
      border: none;
      border-radius: 5px;
      margin-top: 15px;
      cursor: pointer;
      width: 100%;
    }
    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }
    .empty-state {
      text-align: center;
      color: #888;
      margin-top: 30px;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="group-list">
      <h2 style="text-align: center;">Your Groups</h2>
      <div id="groups-container"></div>
    </div>
    <div>
      <button class="add-group-btn" onclick="openGroupModal()">+ Add Group</button>
      <button class="join-group-btn" onclick="openJoinModal()">Join Group</button>
      <div id="google-signin" style="margin-bottom: 5px; margin-top: 20px;">
     <button onclick="handleAuthClick()" style="width: 100%; padding: 10px; background: #4285f4; color: white; border: none; border-radius: 5px;">Sign in with Google</button>
   <div id="user-email" style="margin-top: 10px; font-size: 0.8em;"></div>
   </div>
   <button onclick="signOut()" style="width: 100%; margin-top: 5px; padding: 5px; background: #dc3545; color: white; border: none; border-radius: 5px;">Sign Out</button>
    </div>
  </div>

  <div class="main-content">
    <div class="header" id="header" style="display: none;">
      <h1 id="course-name">Course Name</h1>
      <!-- <div class="tabs">
        <a href="#">Resources</a>
        <a href="#">Discussion</a>
        <a href="#">Study Session</a>
      </div> -->
      <div class="tabs">
        <!-- <a href="/main">Resources</a> -->
        <a href="/qa">Discussion</a>
        <a href="/schedule">Study Session</a>
      </div>
    
    </div>
    <div class="resources" id="resources-container" style="display: none;"></div>
    <div class="empty-state" id="empty-state">No groups added yet. Start by adding or joining a group!</div>
    <div class="add-btn" onclick="openUploadModal()">+</div>
    <div id="uploaded-content-container"></div>
  </div>

  <div class="overlay" id="overlay" onclick="closeModals()"></div>
  <div class="modal" id="group-modal">
    <h2>Add Group</h2>
    <input type="text" id="group-name" placeholder="Enter group name">
    <button onclick="addGroup()">Create Group</button>
  </div>
  <div class="modal" id="join-modal">
    <h2>Join Group</h2>
    <input type="text" id="group-code" placeholder="Enter group code">
    <button onclick="joinGroup()">Join</button>
  </div>
  <div class="modal" id="uploadModal">
    <h2>Upload Course Content</h2>
    <input type="text" id="upload-title" placeholder="Enter title">
    <input type="file" id="upload-file">
    <div style="display: flex; gap: 10px; margin-top: 10px;">
      <button onclick="setContentType('Notes')">Notes</button>
      <button onclick="setContentType('PDF')">PDF</button>
      <button onclick="setContentType('PPT')">PowerPoint</button>
    </div>
    <button style="margin-top: 20px;" onclick="uploadContent()">Upload</button>
  </div>
  <div class="overlay" id="uploadOverlay"></div>

  <script>
    let groups = [];
    let groupCodes = {};
    let resources = {};
    let uploadedContent = [];
    let selectedContentType = "";

    function generateGroupCode() {
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let code = '';
      for (let i = 0; i < 6; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }

    function openGroupModal() {
      document.getElementById("group-modal").style.display = "block";
      document.getElementById("overlay").style.display = "block";
    }

    function openJoinModal() {
      document.getElementById("join-modal").style.display = "block";
      document.getElementById("overlay").style.display = "block";
    }

    function closeModals() {
      document.getElementById("group-modal").style.display = "none";
      document.getElementById("join-modal").style.display = "none";
      document.getElementById("uploadModal").style.display = "none";
      document.getElementById("overlay").style.display = "none";
      document.getElementById("uploadOverlay").style.display = "none";
    }

    function addGroup() {
      const groupNameInput = document.getElementById("group-name");
      const groupName = groupNameInput.value.trim();
      if (groupName && !groups.includes(groupName)) {
        let groupCode;
        do {
          groupCode = generateGroupCode();
        } while (Object.values(groupCodes).includes(groupCode));

        groups.push(groupName);
        groupCodes[groupName] = groupCode;
        resources[groupName] = [];
        renderGroups();
        groupNameInput.value = "";
        closeModals();
        if (groups.length === 1) {
          document.getElementById("header").style.display = "block";
          document.getElementById("resources-container").style.display = "grid";
          document.getElementById("empty-state").style.display = "none";
        }
        setActiveGroup(groupName);
      } else {
        alert("Please enter a valid and unique group name.");
      }
    }

    function joinGroup() {
      const groupCodeInput = document.getElementById("group-code");
      const groupCode = groupCodeInput.value.trim().toUpperCase();
      const groupName = Object.keys(groupCodes).find(name => groupCodes[name] === groupCode);
      if (groupName && !groups.includes(groupName)) {
        groups.push(groupName);
        if (!resources[groupName]) resources[groupName] = [];
        renderGroups();
        groupCodeInput.value = "";
        closeModals();
        if (groups.length === 1) {
          document.getElementById("header").style.display = "block";
          document.getElementById("resources-container").style.display = "grid";
          document.getElementById("empty-state").style.display = "none";
        }
        setActiveGroup(groupName);
      } else if (groups.includes(groupName)) {
        setActiveGroup(groupName);
      } else {
        alert("Invalid group code. Please check the code and try again.");
      }
    }

    function renderGroups() {
      const container = document.getElementById("groups-container");
      container.innerHTML = "";
      groups.forEach(group => {
        const item = document.createElement("a");
        item.className = "group-item";
        item.href = "#";
        item.innerHTML = `${group}<div class="group-code">Code: ${groupCodes[group]}</div>`;
        item.onclick = () => setActiveGroup(group);
        container.appendChild(item);
      });
    }

    function setActiveGroup(groupName) {
      document.querySelectorAll(".group-item").forEach(item => {
        item.classList.toggle("active", item.textContent.includes(groupName));
      });
      document.getElementById("course-name").textContent = groupName;
      renderResources(groupName);
    }

    function openUploadModal() {
      if (groups.length === 0) return alert("Please add or join a group first.");
      document.getElementById("uploadModal").style.display = "block";
      document.getElementById("uploadOverlay").style.display = "block";
    }

    function setContentType(type) {
      selectedContentType = type;
    }

  async function uploadContent() {
  if (!googleAccessToken) return alert('Please sign in with Google first');
  
  const title = document.getElementById("upload-title").value.trim();
  const file = document.getElementById("upload-file").files[0];
  if (!title || !file || !selectedContentType) return alert("Please enter a title, choose a file, and select content type.");

  const metadata = {
    name: file.name,
    mimeType: file.type,
    parents: ['root'], // You can specify folder ID here
    description: `Uploaded via PeerSphere - ${selectedContentType}`,
    properties: {
      title: title,
      contentType: selectedContentType
    }
  };

  const formData = new FormData();
  formData.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
  formData.append('file', file);

  try {
    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
      method: 'POST',
      headers: {
        Authorization: `Bearer ${googleAccessToken}`
      },
      body: formData
    });
    
    const data = await response.json();
    
    uploadedContent.push({
      name: title,
      fileName: file.name,
      type: selectedContentType,
      driveId: data.id,
      webViewLink: data.webViewLink,
      downloadLink: `https://www.googleapis.com/drive/v3/files/${data.id}?alt=media`,
      likes: 0,
      hearts: 0
    });

    document.getElementById("upload-title").value = "";
    document.getElementById("upload-file").value = "";
    selectedContentType = "";
    closeModals();
    renderUploadedContent();
  } catch (error) {
    console.error('Upload failed:', error);
    alert('Upload failed. Please try again.');
  }
}


    function renderResources(groupName) {
      const container = document.getElementById("resources-container");
      container.innerHTML = "";
      if (resources[groupName]) {
        resources[groupName].forEach(resource => {
          const div = document.createElement("div");
          div.className = "resource-item";
          div.innerHTML = `<h3>${resource.name}</h3><p>${resource.fileName}</p>`;
          container.appendChild(div);
        });
      }
    }

  function renderUploadedContent() {
  const container = document.getElementById("uploaded-content-container");
  container.innerHTML = "<h2>Your Uploaded Content</h2>";
  uploadedContent.forEach((item, index) => {
    const ext = item.fileName.split('.').pop().toLowerCase();
    let filePreview = "";

if (["jpg", "jpeg", "png", "gif", "bmp", "webp"].includes(ext)) {
  filePreview = `
    <img src="${item.downloadLink}" alt="${item.name}" style="max-width: 100px; max-height: 100px; margin-top: 10px;">
    <br><a href="${item.downloadLink}" download>üì• Download</a>`;
} else {
  filePreview = `
    <a href="${item.webViewLink}" target="_blank">üåê View</a>
    <br><a href="${item.downloadLink}" download>üì• Download</a>`;
}

    const div = document.createElement("div");
    div.style.cssText = "background: #fff; border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;";
    div.innerHTML = `
      <div>
        <strong>${item.name}</strong><br>
        <em>${item.type}</em><br>
        ${filePreview}
      </div>
      <div style="display: flex; gap: 10px;">
        <button onclick="reactToContent(${index}, 'likes')">üëç ${item.likes}</button>
        <button onclick="reactToContent(${index}, 'hearts')">‚ù§Ô∏è ${item.hearts}</button>
      </div>
    `;
    container.appendChild(div);
  });
}

function signOut() {
  google.accounts.oauth2.revoke(googleAccessToken);
  googleAccessToken = null;
  document.getElementById('google-signin').style.display = 'block';
  document.getElementById('user-email').textContent = '';
}

    function reactToContent(index, type) {
      if (uploadedContent[index]) {
        uploadedContent[index][type]++;
        renderUploadedContent();
      }
    }

let googleAccessToken = null;
let gapiInited = false;

function gapiLoaded() {
  gapi.load('client', initializeGapiClient);
}

async function initializeGapiClient() {
  await gapi.client.init({
    apiKey: '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',
    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
  });
  gapiInited = true;
}

function handleAuthClick() {
  if (!gapiInited) return;
  
  const client = google.accounts.oauth2.initTokenClient({
    client_id: '79963321739-ohganequmb0bb9ciul765qj1fclraep7.apps.googleusercontent.com',
    scope: 'https://www.googleapis.com/auth/drive.file',
    callback: (response) => {
      if (response.error) return;
      googleAccessToken = response.access_token;
      document.getElementById('google-signin').style.display = 'none';
      // Get user email
      fetch('https://www.googleapis.com/oauth2/v1/userinfo?alt=json', {
        headers: {
          Authorization: `Bearer ${googleAccessToken}`
        }
      })
      .then(res => res.json())
      .then(data => {
        document.getElementById('user-email').textContent = data.email;
      });
    },
  });
  client.requestAccessToken();
}


    document.getElementById("uploadOverlay").addEventListener("click", closeModals);
  renderGroups();

  function runTests() {
    console.log("=== Running PeerSphere Tests ===");

    // Test 1: Add Group
    const testGroupName = "Test Group";
    document.getElementById("group-name").value = testGroupName;
    addGroup();
    console.assert(groups.includes(testGroupName), "Test 1 Failed: Group was not added.");
    console.log("Test 1 Passed: Group added");

    // Test 2: Upload Content
    const dummyFile = new File(["dummy data"], "example.pdf", { type: "application/pdf" });
    document.getElementById("upload-title").value = "Test Upload";
    const uploadInput = document.getElementById("upload-file");
    Object.defineProperty(uploadInput, 'files', {
      value: [dummyFile],
      writable: false
    });
    selectedContentType = "PDF";
    uploadContent();
    console.assert(uploadedContent.length > 0, "Test 2 Failed: Content not uploaded.");
    console.log("Test 2 Passed: Content uploaded");

    // Test 3: React to Content
    const previousLikes = uploadedContent[0].likes;
    reactToContent(0, "likes");
    console.assert(uploadedContent[0].likes === previousLikes + 1, "Test 3 Failed: Like not registered.");
    console.log("Test 3 Passed: Like registered");

    // Test 4: Add Comment
    const testComment = "Great upload!";
    uploadedContent[0].comments = []; // reset
    const mockInput = { value: testComment };
    addComment(0, mockInput);
    console.assert(uploadedContent[0].comments.includes(testComment), "Test 4 Failed: Comment not added.");
    console.log("Test 4 Passed: Comment added");

    console.log("‚úÖ All tests completed.");
  }

  window.onload = () => {
    renderGroups();
    runTests(); // Comment this line out if you don‚Äôt want tests to run on page load
  };
</script>
</body>
</html>
