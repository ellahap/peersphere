<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PeerSphere</title>
  <style>
    body {
      display: flex;
      margin: 0;
      font-family: Courier, monospace;
      background: #f5f5f5;
      height: 100vh;
    }
    h2 {
      margin-bottom: 10px;
      padding-bottom: 5px;
    }
    .sidebar {
      background: #dbdbdb;
      padding: 20px;
      width: 200px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      justify-content: space-between;
      height: auto;
      max-height: 100vh;
      overflow-y: auto;
    }
    .group-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .group-item {
      display: block;
      padding: 10px;
      border-radius: 20px;
      text-decoration: none;
      color: black;
      cursor: pointer;
      width: 100%;
      box-sizing: border-box;
      text-align: left;
      margin-bottom: 5px;
      position: relative;
    }
    .group-item.active {
      background: #1f497d;
      color: white;
    }
    .group-code {
      font-size: 0.8em;
      color: #666;
      margin-top: 5px;
    }
    .group-item.active .group-code {
      color: #ccc;
    }
    .main-content {
      flex-grow: 1;
      padding: 20px;
    }
    .header {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    .tabs {
      display: flex;
      gap: 50px;
      padding-top: 5px;
      padding-bottom: 20px;
    }
    .tabs a {
      text-decoration: none;
      color: black;
      background-color: #dbdbdb;
      padding: 10px 20px;
      border-radius: 10px;
      font-weight: bold;
      transition: background-color 0.3s;
    }
    .tabs a:hover {
      background-color: #1f497d;
      color: white;
    }
    .resources {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 30px; /* uniform gap between cards */
      margin-top: 30px;
      padding: 10px;
    }

    .resource-item {
      background: #ffffff;
      width: 240px;
      height: 280px; /* fixed height */
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      justify-content: space-between; /* distribute content inside the fixed height */
      align-items: center;
      text-align: center;
      font-weight: bold;
    }


    
    .resource-item > * {
      margin-top: 0;
    }
    .add-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background: rgb(47, 47, 47);
      color: white;
      border-radius: 50%;
      font-size: 40px;
      text-align: center;
      line-height: 60px;
      cursor: pointer;
    }
    .add-group-btn, .join-group-btn {
      padding: 10px;
      border-radius: 5px;
      border: none;
      color: white;
      cursor: pointer;
      text-align: center;
      margin-top: 10px;
      width: 100%;
      background: #1f497d;
    }
    .modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      width: 300px;
    }
    .modal h2 {
      margin-top: 0;
    }
    .modal input {
      width: 92%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .modal button {
      padding: 10px 20px;
      background: #1f497d;
      color: white;
      border: none;
      border-radius: 5px;
      margin-top: 15px;
      cursor: pointer;
      width: 100%;
    }
    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }
    .empty-state {
      text-align: center;
      color: #888;
      margin-top: 30px;
      font-size: 18px;
    }
  </style>

</head>
<body>
  <div class="sidebar">
    <div class="group-list">
      <h2 style="text-align: center;">Your Groups</h2>
      <div id="groups-container"></div>
    </div>
    <div>
      <button class="add-group-btn" onclick="openGroupModal()">+ Add Group</button>
      <button class="join-group-btn" onclick="openJoinModal()">Join Group</button>
    </div>
  </div>

  <div class="main-content">
    <div class="header" id="header" style="display: none;">
      <h1 id="course-name">Course Name</h1>
      <div class="tabs">
        <a id="discussion-tab" href="#">Discussion</a>
        <a id="schedule-tab" href="#">Study Session</a>
      </div>      
    </div>
    <div class="resources" id="resources-container" style="display: none;"></div>
    <div class="empty-state" id="empty-state">No groups added yet. Start by adding or joining a group!</div>
    <div class="add-btn" onclick="openUploadModal()">+</div>
  </div>

  <!-- Modals & overlays -->
  <div class="overlay" id="overlay" onclick="closeModals()"></div>
  <div class="modal" id="group-modal">
    <h2>Add Group</h2>
    <input type="text" id="group-name" placeholder="Enter group name">
    <button onclick="addGroup()">Create Group</button>
  </div>
  <div class="modal" id="join-modal">
    <h2>Join Group</h2>
    <input type="text" id="group-code" placeholder="Enter group code">
    <button onclick="joinGroup()">Join</button>
  </div>
  <div class="modal" id="uploadModal">
    <h2>Upload Course Content</h2>
    <input type="text" id="upload-title" placeholder="Enter title">
    <input type="file" id="upload-file">
    <div style="display: flex; gap: 10px; margin-top: 10px;">
      <button onclick="setContentType('Notes')">Notes</button>
      <button onclick="setContentType('PDF')">PDF</button>
      <button onclick="setContentType('PPT')">PowerPoint</button>
    </div>
    <button style="margin-top: 20px;" onclick="uploadContent()">Upload</button>
  </div>
  <div class="overlay" id="uploadOverlay"></div>

  <script>
    function getGroupIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get("group");
    }

    




    let groupMap = {}; // { groupId: { name, join_code, resources: [] } }
    let currentGroupId = null;
    let selectedContentType = "";

    function generateGroupCode() {
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      return Array.from({ length: 6 }, () => chars[Math.floor(Math.random() * chars.length)]).join('');
    }

    function openGroupModal() {
      document.getElementById("group-modal").style.display = "block";
      document.getElementById("overlay").style.display = "block";
    }

    function openJoinModal() {
      document.getElementById("join-modal").style.display = "block";
      document.getElementById("overlay").style.display = "block";
    }

    function closeModals() {
      document.querySelectorAll('.modal').forEach(modal => modal.style.display = 'none');
      document.querySelectorAll('.overlay').forEach(overlay => overlay.style.display = 'none');
    }

    function openUploadModal() {
      if (!currentGroupId) {
        alert("Please add or join a group first.");
        return;
      }
      document.getElementById("uploadModal").style.display = "block";
      document.getElementById("uploadOverlay").style.display = "block";
    }


    async function addGroup() {
      const groupName = document.getElementById("group-name").value.trim();
      if (!groupName) return alert("Please enter a group name.");

      const join_code = generateGroupCode();
      const res = await fetch('/api/groups', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: groupName, join_code })
      });
      const data = await res.json();
      if (res.ok) {
        groupMap[data.id] = { name: data.name, join_code: data.join_code, resources: [] };
        currentGroupId = data.id;
        renderGroups();
        document.getElementById("group-name").value = "";
        closeModals();
        updateUIVisibility();
        setActiveGroup(currentGroupId);
      } else {
        alert(data.error || "Error creating group.");
      }
    }

    async function joinGroup() {
      const groupCode = document.getElementById("group-code").value.trim().toUpperCase();
      const res = await fetch('/api/join', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ join_code: groupCode })
      });
      const data = await res.json();
      if (res.ok) {
        if (!groupMap[data.id]) {
          groupMap[data.id] = { name: data.name, join_code: groupCode, resources: [] };
        }
        currentGroupId = data.id;
        renderGroups();
        document.getElementById("group-code").value = "";
        closeModals();
        updateUIVisibility();
        setActiveGroup(currentGroupId);
      } else {
        alert("Invalid group code.");
      }
    }

    async function loadGroups() {
      const res = await fetch('/api/groups');
      const data = await res.json();
      groupMap = {};
      data.forEach(g => {
        groupMap[g.id] = { name: g.name, join_code: g.join_code, resources: [] };
      });

      const groupIdFromUrl = getGroupIdFromUrl();
      const validGroupId = groupIdFromUrl && groupMap[groupIdFromUrl] ? groupIdFromUrl : Object.keys(groupMap)[0];

      if (validGroupId) {
        currentGroupId = validGroupId;
        updateUIVisibility();
        renderGroups();
        setActiveGroup(currentGroupId);
      } else {
        updateUIVisibility();
      }
    }


    function renderGroups() {
      const container = document.getElementById("groups-container");
      container.innerHTML = "";
      for (const [id, group] of Object.entries(groupMap)) {
        const item = document.createElement("a");
        item.className = "group-item";
        item.href = "#";
        item.innerHTML = `${group.name}<div class="group-code">Code: ${group.join_code}</div>`;
        item.onclick = () => setActiveGroup(id);
        if (id === currentGroupId) item.classList.add("active");
        container.appendChild(item);
      }
    }

    function setActiveGroup(groupId) {
      currentGroupId = groupId;
      document.getElementById("course-name").textContent = groupMap[groupId].name;
      renderResources(groupId);
      renderGroups();
      updateUIVisibility();

  

      document.getElementById("discussion-tab").href = `/qa?group=${groupId}`;
      document.getElementById("schedule-tab").href = `/schedule?group=${groupId}`;
    }

    


    function updateUIVisibility() {
      const hasGroups = Object.keys(groupMap).length > 0;
      document.getElementById("header").style.display = hasGroups ? "block" : "none";
      document.getElementById("resources-container").style.display = hasGroups ? "grid" : "none";
      document.getElementById("empty-state").style.display = hasGroups ? "none" : "block";
    }


    function renderResources(groupId) {
      const container = document.getElementById("resources-container");
      container.innerHTML = "";
      const group = groupMap[groupId];
      if (group && group.resources.length > 0) {
        group.resources.forEach((item, index) => {
          const ext = item.fileName.split('.').pop().toLowerCase();
          let filePreview = "";
          const url = `/download/${encodeURIComponent(item.fileName)}`;

          if (["jpg", "jpeg", "png", "gif", "bmp", "webp"].includes(ext)) {
            filePreview = `<img src="${url}" style="max-width:100px; max-height:100px;"><br><a href="${url}" download>游닌 Download</a>`;
          } else if (ext === "pdf") {
            filePreview = `<iframe src="${url}" width="100" height="100"></iframe><br><a href="${url}" download>游닌 Download</a>`;
          } else if (["ppt", "pptx", "doc", "docx"].includes(ext)) {
            filePreview = `<iframe src="https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(url)}" width="100" height="100"></iframe><br><a href="${url}" download>游닌 Download</a>`;
          } else {
            filePreview = `<a href="${url}" download>游닌 Download</a>`;
          }

          const div = document.createElement("div");
          div.className = "resource-item";
          div.innerHTML = `
            <div>
              <strong>${item.name}</strong><br>
              <em>${item.type}</em><br>
              ${filePreview}
            </div>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 10px;">
              <button onclick="reactToContent(${index}, 'likes')">游녨 ${item.likes}</button>
              <button onclick="reactToContent(${index}, 'hearts')">仇벒잺 ${item.hearts}</button>
            </div>`;
          container.appendChild(div);
        });
      }
    }

    async function uploadContent() {
      const title = document.getElementById("upload-title").value.trim();
      const file = document.getElementById("upload-file").files[0];
      if (!title || !file || !selectedContentType || !currentGroupId) return alert("Please complete all fields.");


      const formData = new FormData();
      formData.append("file", file);

      const uploadRes = await fetch("/upload", {
        method: "POST",
        body: formData
      });
      const uploadData = await uploadRes.json();
      const serverFileName = uploadData.filename;

      groupMap[currentGroupId].resources.push({
        name: title,
        fileName: serverFileName,
        type: selectedContentType,
        likes: 0,
        hearts: 0
      });


      document.getElementById("upload-title").value = "";
      document.getElementById("upload-file").value = "";
      selectedContentType = "";
      closeModals();
      renderResources(currentGroupId);
    }



    function reactToContent(index, type) {
      if (groupMap[currentGroupId] && groupMap[currentGroupId].resources[index]) {
        groupMap[currentGroupId].resources[index][type]++;
        renderResources(currentGroupId);
      }
    }

  



    function setContentType(type) {
      selectedContentType = type;
    }

    document.getElementById("uploadOverlay").addEventListener("click", closeModals);
    window.onload = loadGroups;
    
  </script>
</body>
</html>